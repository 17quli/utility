 /********************************************************************************************
05/12/19 ird0sxr1 First Cut - Only tblCollect for now. tblPeriod is still being tested as it is 395+ million rows table
06/12/19 ird0sxr1 Added tbl_nz_rtniit back as it had originally missed the Batch2 cut
09/12/19 ird0sxr1 Added tbl_period too
10/12/19 ird0sxr1 Added details of Impala script for updating record_effective_timestamp to '1800-01-01  00.00.00' for each NK having lowest record_effective_timestamp


*********************************************************************************************/

-- Backup existing RAW START tables touched by history migration process

select count(*) as raw_count from  ${target_db=Enter the target database name here}_raw.app_tblcollect;
create table  ${target_db=Enter the target database name here}_raw.app_tblcollect_YYYYMMDD stored as parquet
as select * from  ${target_db=Enter the target database name here}_raw.app_tblcollect;
select count(*) as backup_count from  ${target_db=Enter the target database name here}_raw.app_tblcollect_YYYYMMDD;

select count(*) as raw_count from  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;
create table  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT_YYYYMMDD stored as parquet
as select * from  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;
select count(*) as backup_count from  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT_YYYYMMDD;

select count(*) as raw_count from  ${target_db=Enter the target database name here}_raw.app_tblperiod;
create table  ${target_db=Enter the target database name here}_raw.app_tblperiod_YYYYMMDD stored as parquet
as select * from  ${target_db=Enter the target database name here}_raw.app_tblperiod;
select count(*) as backup_count from  ${target_db=Enter the target database name here}_raw.app_tblperiod_YYYYMMDD;



-- Backup existing RAW TDW tables touched by history migration process

select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect;
create table  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect_YYYYMMDD stored as parquet
as select * from  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect;
select count(*) as raw_tdw_backup_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect_YYYYMMDD;


select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT;
create table  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT_YYYYMMDD stored as parquet
as select * from  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT;
select count(*) as raw_tdw_backup_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT_YYYYMMDD;

select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_period;
create table  ${target_db=Enter the target database name here}_raw.tdw_tbl_period_YYYYMMDD stored as parquet
as select * from  ${target_db=Enter the target database name here}_raw.tdw_tbl_period;
select count(*) as raw_tdw_backup_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_period_YYYYMMDD;
-- Truncate existing RAW tables for START

truncate table  ${target_db=Enter the target database name here}_raw.app_tblcollect;
select count(*) as raw_count from  ${target_db=Enter the target database name here}_raw.app_tblcollect;

truncate table  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;
select count(*) as raw_count from  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;

truncate table  ${target_db=Enter the target database name here}_raw.app_tblperiod;
select count(*) as raw_count from  ${target_db=Enter the target database name here}_raw.app_tblperiod;

-- Truncate existing RAW tables for TDW

truncate table  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect;
select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect;

truncate table  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT;
select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT;

truncate table  ${target_db=Enter the target database name here}_raw.tdw_tbl_period;
select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_period;

-- Run Checks on TDW tables and START tables in SAS EG or SAS Studio (Use TDW History Load Check code: History Analysis - STEP 1). Export Results as PDF.

-- Run the Code generated by SAS DI Studio Jobs in SAS EG or SAS Studio to populate the RAW TDW tables. Save the Logs.

-- Check records in RAW TDW tables
select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect;
select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT;
select count(*) as raw_tdw_count from  ${target_db=Enter the target database name here}_raw.tdw_tbl_period;


-- Using Impala commands Load data manually from RAW TDW tables into RAW START tables

INSERT INTO TABLE  ${target_db=Enter the target database name here}_raw.app_tblcollect
SELECT
CAST(FLNGCOLLECTKEY AS INT) AS flngCollectKey,
CAST(FLNGVER AS INT) AS flngVer,
CAST(FLNGVERLAST AS INT) AS flngVerLast,
CAST(FSTRCATEGORY AS VARCHAR(12)) AS fstrCategory,
CAST(FSTRCOLLECTTYPE AS VARCHAR(12)) AS fstrCollectType,
CAST(FLNGCUSTOMERKEY AS INT) AS flngCustomerKey,
CAST(FLNGCUSTOMERKEY2 AS INT) AS flngCustomerKey2,
CAST(FLNGACCOUNTKEY AS INT) AS flngAccountKey,
CAST(FINTCOLLECTPROFILENUMBER AS SMALLINT) AS fintCollectProfileNumber,
CAST(FLNGJOURNALKEY AS INT) AS flngJournalKey,
CAST(FLNGINDICATORKEY AS INT) AS flngIndicatorKey,
CAST(FLNGFOLDERKEY AS INT) AS flngFolderKey,
CAST(FCURTAX AS DECIMAL(19,4)) AS fcurTax,
CAST(FCURPENALTY AS DECIMAL(19,4)) AS fcurPenalty,
CAST(FCURINTEREST AS DECIMAL(19,4)) AS fcurInterest,
CAST(FCURBALANCE AS DECIMAL(19,4)) AS fcurBalance,
CAST(FSTRCOLLECTDISTRICTOFFICE AS VARCHAR(12)) AS fstrCollectDistrictOffice,
CAST(FSTRACCOUNTTYPE AS VARCHAR(12)) AS fstrAccountType,
CAST(FDTMWORKDATE AS TIMESTAMP) AS fdtmWorkDate,
CAST(FDTMWORKDATETIME AS TIMESTAMP) AS fdtmWorkDateTime,
CAST(FDTMCREATIONDATE AS TIMESTAMP) AS fdtmCreationDate,
CAST(FDTMCLOSEDDATE AS TIMESTAMP) AS fdtmClosedDate,
CAST(FBLNAUTOMATED AS SMALLINT) AS fblnAutomated,
CAST(FDTMNEXTSTAGE AS TIMESTAMP) AS fdtmNextStage,
CAST(FSTRSTAGEFLOW AS VARCHAR(12)) AS fstrStageFlow,
CAST(FSTRSTAGE AS VARCHAR(12)) AS fstrStage,
CAST(FSTROWNER AS VARCHAR(20)) AS fstrOwner,
CAST(FLNGRISK AS INT) AS flngRisk,
CAST(FSTRLASTCOMPLETEDSTAGE AS VARCHAR(12)) AS fstrLastCompletedStage,
CAST(FLNGTEAMKEY AS INT) AS flngTeamKey,
CAST(FLNGDOCKEY AS INT) AS flngDocKey,
CAST(FSTRWHO AS VARCHAR(20)) AS fstrWho,
CAST(EFFECTIVE_FROM AS TIMESTAMP) AS FDTMWHEN,
CAST(record_effective_timestamp AS TIMESTAMP) AS record_effective_timestamp,
CAST(record_expiry_timestamp AS TIMESTAMP) AS record_expiry_timestamp,
CAST(CURRENT_REC_FLAG AS VARCHAR(1)) AS record_active_flag,
CAST('N' AS VARCHAR(1)) AS record_deleted_flag,
CAST(insert_object_run_key AS INT) AS insert_object_run_key,
CAST(update_object_run_key AS INT) AS update_object_run_key
FROM  ${target_db=Enter the target database name here}_raw.tdw_tbl_collect;

/*Old one - Should be RUN*/
INSERT INTO  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT
SELECT
CAST(FLNGDOCKEY AS INT) AS flngDocKey,
CAST(FBLNIR215ATTACHED AS SMALLINT) AS fblnIR215Attached,
CAST(FCURTOTALFAMILYTAXCREDIT AS DECIMAL(19,4)) AS fcurTotalFamilyTaxCredit,
CAST(FCURTOTALPAYEDEDUCTED AS DECIMAL(19,4)) AS fcurTotalPAYEDeducted,
CAST(FCURTOTALADJPAYEDEDUCTED AS DECIMAL(19,4)) AS fcurTotalAdjPAYEDeducted,
CAST(FCURTOTALGROSSINCOME AS DECIMAL(19,4)) AS fcurTotalGrossIncome,
CAST(FCURINCOMENOTLIABLEFORACC AS DECIMAL(19,4)) AS fcurIncomeNotLiableForACC,
CAST(FCURACCEARNERLEVY AS DECIMAL(19,4)) AS fcurACCEarnerLevy,
CAST(FCURTOTALINCOMEWITHTAXDEDUCTED AS DECIMAL(19,4)) AS fcurTotalIncomeWithTaxDeducted,
CAST(FCURTOTALSCHEDULARPYMTTAXDED AS DECIMAL(19,4)) AS fcurTotalSchedularPymtTaxDed,
CAST(FCURTOTALGROSSSCHEDULARPAYMENT AS DECIMAL(19,4)) AS fcurTotalGrossSchedularPayment,
CAST(FCUREXPENSESSCHEDULARPAYMENTS AS DECIMAL(19,4)) AS fcurExpensesSchedularPayments,
CAST(FCURNETSCHEDULARPAYMENTS AS DECIMAL(19,4)) AS fcurNetSchedularPayments,
CAST(FCURTOTALRWT AS DECIMAL(19,4)) AS fcurTotalRWT,
CAST(FCURTOTALGROSSINTEREST AS DECIMAL(19,4)) AS fcurTotalGrossInterest,
CAST(FBLNINTPSHPLTC AS SMALLINT) AS fblnIntPshpLTC,
CAST(FCURTOTALIMPUTATIONCREDITS AS DECIMAL(19,4)) AS fcurTotalImputationCredits,
CAST(FCURTOTALDIVIDENDRWT AS DECIMAL(19,4)) AS fcurTotalDividendRWT,
CAST(FCURTOTALGROSSDIVIDENDS AS DECIMAL(19,4)) AS fcurTotalGrossDividends,
CAST(FBLNDIVPSHPLTC AS SMALLINT) AS fblnDivPshpLTC,
CAST(FCURTOTALMAORICREDITS AS DECIMAL(19,4)) AS fcurTotalMaoriCredits,
CAST(FCURTOTALMAORIDISTRIBUTIONS AS DECIMAL(19,4)) AS fcurTotalMaoriDistributions,
CAST(FCURTOTALTAXPAIDBYTRUSTEES AS DECIMAL(19,4)) AS fcurTotalTaxPaidByTrustees,
CAST(FCURTOTALESTATEORTRUSTEEINCOME AS DECIMAL(19,4)) AS fcurTotalEstateOrTrusteeIncome,
CAST(FCURTOTALTAXABLEDISTRIBUTIONS AS DECIMAL(19,4)) AS fcurTotalTaxableDistributions,
CAST(FCURTOTALOVERSEASTAXPAID AS DECIMAL(19,4)) AS fcurTotalOverseasTaxPaid,
CAST(FCURTOTALOVERSEASINCOME AS DECIMAL(19,4)) AS fcurTotalOverseasIncome,
CAST(FBLNOVERSEASSUPER AS SMALLINT) AS fblnOverseasSuper,
CAST(FCURTOTALPARTNERSHIPTAXCREDITS AS DECIMAL(19,4)) AS fcurTotalPartnershipTaxCredits,
CAST(FCURTOTALACTIVEPTSHPINCOME AS DECIMAL(19,4)) AS fcurTotalActivePtshpIncome,
CAST(FCURTOTALLTCTAXCREDITS AS DECIMAL(19,4)) AS fcurTotalLTCTaxCredits,
CAST(FCURTOTALACTIVELTCINCOME AS DECIMAL(19,4)) AS fcurTotalActiveLTCIncome,
CAST(FCURNONALLOWABLEDEDUCTIONS AS DECIMAL(19,4)) AS fcurNonAllowableDeductions,
CAST(FCURNONALLOWABLEDEDCLAIMED AS DECIMAL(19,4)) AS fcurNonAllowableDedClaimed,
CAST(FCURADJUSTEDLTCINCOME AS DECIMAL(19,4)) AS fcurAdjustedLTCIncome,
CAST(FCURTAXCREDITSUBTOTAL AS DECIMAL(19,4)) AS fcurTaxCreditSubtotal,
CAST(FCURINCOMESUBTOTAL AS DECIMAL(19,4)) AS fcurIncomeSubtotal,
CAST(FCURSHAREHOLDEREMPLOYEESALARY AS DECIMAL(19,4)) AS fcurShareholderEmployeeSalary,
CAST(FBLNFUTURESHRSALARY AS SMALLINT) AS fblnFutureShrSalary,
CAST(FBLNWITHOUTPAYCLOSECOMPANY AS SMALLINT) AS fblnWithoutPayCloseCompany,
CAST(FCURNETRENTS AS DECIMAL(19,4)) AS fcurNetRents,
CAST(FCURSELFEMPLOYEDNETINCOME AS DECIMAL(19,4)) AS fcurSelfEmployedNetIncome,
CAST(FCURTOTALOTHERNETINCOME AS DECIMAL(19,4)) AS fcurTotalOtherNetIncome,
CAST(FCURRLWTCREDIT AS DECIMAL(19,4)) AS fcurRLWTCredit,
CAST(FCURTOTALINCOME AS DECIMAL(19,4)) AS fcurTotalIncome,
CAST(FCURTOTALOTHEREXPENSES AS DECIMAL(19,4)) AS fcurTotalOtherExpenses,
CAST(FCURINCOMEAFTEREXPENSES AS DECIMAL(19,4)) AS fcurIncomeAfterExpenses,
CAST(FCURAMOUNTBROUGHTFORWARD AS DECIMAL(19,4)) AS fcurAmountBroughtForward,
CAST(FCURAMOUNTCLAIMEDTHISYEAR AS DECIMAL(19,4)) AS fcurAmountClaimedThisYear,
CAST(FCURTAXABLEINCOME AS DECIMAL(19,4)) AS fcurTaxableIncome,
CAST(FBLNELIGIBLEFORIETC AS SMALLINT) AS fblnEligibleForIETC,
CAST(FDTMEXOVERSEASINCOMESTART AS TIMESTAMP) AS fdtmExOverseasIncomeStart,
CAST(FDTMEXCOVERSEASINCOMEEND AS TIMESTAMP) AS fdtmExcOverseasIncomeEnd,
CAST(FINTEXCOVERSEASMONTHS AS SMALLINT) AS fintExcOverseasMonths,
CAST(FCURIETC AS DECIMAL(19,4)) AS fcurIETC,
CAST(FCURALLOWABLEIMPCREDITS AS DECIMAL(19,4)) AS fcurAllowableImpCredits,
CAST(FCUREXCESSIMPUTATIONCREDITS AS DECIMAL(19,4)) AS fcurExcessImputationCredits,
CAST(FCURTOTALEXTTCPD AS DECIMAL(19,4)) AS fcurTotalExtTCPD,
CAST(FCURTOTALTCPD AS DECIMAL(19,4)) AS fcurTotalTCPD,
CAST(FCURTAXONTAXABLEINCOME AS DECIMAL(19,4)) AS fcurTaxOnTaxableIncome,
CAST(FCURRESIDUALINCOMETAX AS DECIMAL(19,4)) AS fcurResidualIncomeTax,
CAST(FCURTAXCALCRESULT AS DECIMAL(19,4)) AS fcurTaxCalcResult,
CAST(FCURIMPUTATIONTOCARRYFORWARD AS DECIMAL(19,4)) AS fcurImputationToCarryForward,
CAST(FBLNEARLYPYMTDISCOUNT AS SMALLINT) AS fblnEarlyPymtDiscount,
CAST(FCUROVERPAYMENTPROVREFUND AS DECIMAL(19,4)) AS fcurOverpaymentProvRefund,
CAST(FCURREFUNDANDPROVOVERPAYMENT AS DECIMAL(19,4)) AS fcurRefundAndProvOverpayment,
CAST(FCURREFUNDCALC AS DECIMAL(19,4)) AS fcurRefundCalc,
CAST(FCURPROVISIONALTAX AS DECIMAL(19,4)) AS fcurProvisionalTax,
CAST(FCURLOSSTOCARRYFORWARD AS DECIMAL(19,4)) AS fcurLossToCarryForward,
CAST(FCURALLOWABLERLWTCREDITS AS DECIMAL(19,4)) AS fcurAllowableRLWTCredits,
CAST(FCURPROVISIONALTAXPAID AS DECIMAL(19,4)) AS fcurProvisionalTaxPaid,
CAST(FCURREFUND AS DECIMAL(19,4)) AS fcurRefund,
CAST(FBLNDISCLOSUREREQUIRED AS SMALLINT) AS fblnDisclosureRequired,
CAST(FSTRPTSSTATUS AS VARCHAR(12)) AS fstrPTSStatus,
CAST(FLNGSELECTGROUP AS INT) AS flngSelectGroup,
CAST(FDTMSELECTDATE AS TIMESTAMP) AS fdtmSelectDate,
CAST(FBLNGROUP2SUSPEND AS SMALLINT) AS fblnGroup2Suspend,
CAST(FSTRWHO AS VARCHAR(20)) AS fstrWho,
CAST(EFFECTIVE_FROM AS TIMESTAMP) AS FDTMWHEN,
CAST(record_effective_timestamp AS TIMESTAMP) AS record_effective_timestamp,
CAST(record_expiry_timestamp AS TIMESTAMP) AS record_expiry_timestamp,
CAST(CURRENT_REC_FLAG AS VARCHAR(1)) AS record_active_flag,
CAST('N' AS VARCHAR(1)) AS record_deleted_flag,
CAST(insert_object_run_key AS INT) AS insert_object_run_key,
CAST(update_object_run_key AS INT) AS update_object_run_key
FROM  ${target_db=Enter the target database name here}_raw.tdw_tbl_NZ_RtnIIT;

/**Start of Update Script - 1800-01-01 :00:00:00 updates for record_effective_timestamp within tdw_tbl_period**/
/**Note: This should be run only after loading of TDW Raw table tdw_tbl_period is completed AND before we load app_tbl_period **/

/**Get the list of all Natural Keys (NK) with the minimum record_effective_timestamp for each of them and store them in a temp table**/
drop table if exists ${target_db=Enter the target database name here}_raw.tdw_tbl_period_1800_final_updates;
create table ${target_db=Enter the target database name here}_raw.tdw_tbl_period_1800_final_updates stored as parquet
as select min(record_effective_timestamp) as min_record_effective_timestamp,flngaccountkey,fdtmfilingperiod
from ${target_db=Enter the target database name here}_raw.tdw_tbl_period
group by flngaccountkey,fdtmfilingperiod;

/**create another temp table with all records from orig tdw_tbl_period table with nccesary updates from tdw_tbl_period_1800_final_updates for record_effective_stamp='1800-01-01 00.00.00'**/
drop table if exists ${target_db=Enter the target database name here}_raw.tdw_tbl_period_final;
create table ${target_db=Enter the target database name here}_raw.tdw_tbl_period_final stored as parquet
as select 
a.FLNGACCOUNTKEY,
a.FDTMFILINGPERIOD,
a.FLNGVER,
a.FLNGVERLAST,
a.FLNGLINKEDACCOUNTKEY,
a.FLNGJOINTACCOUNTKEY,
a.FBLNPRIME,
a.FDTMPERIODBEGIN,
a.FDTMPERIODEND,
a.FSTRFILING,
a.FCURTAX,
a.FCURTAXBALANCE,
a.FCURTAXDELTA,
a.FCURINTEREST,
a.FCURINTERESTBALANCE,
a.FCURINTERESTDELTA,
a.FCURPENALTY,
a.FCURPENALTYBALANCE,
a.FCURPENALTYDELTA,
a.FCUROTHER,
a.FCUROTHERBALANCE,
a.FCUROTHERDELTA,
a.FCURCREDIT,
a.FCURCREDITBALANCE,
a.FCURCREDITDELTA,
a.FCURBALANCE,
a.FDTMACTIVITY,
a.FDTMPENALTY,
a.FDTMEFFECTMAX,
a.FDTMDELTA,
a.FDTMSTATUTE,
a.FDTMSYSTEMSTATUTE,
a.FDTMUSERSTATUTE,
a.FBLNSBAEXISTS,
a.FBLNRA,
a.FBLNPNI,
a.FLNGDOCKEY,
a.FBLNACTIVE,
a.FSTRWHO,
a.EFFECTIVE_FROM,
a.EFFECTIVE_TO,
a.CURRENT_REC_FLAG,
a.CUSTOMER_KEY,
--a.record_effective_timestamp as orig_record_effective_timestamp,
CASE WHEN
a.record_effective_timestamp=b.min_record_effective_timestamp THEN '1800-01-01 00:00:00'
ELSE a.record_effective_timestamp
END record_effective_timestamp,
a.record_expiry_timestamp,
a.record_active_flag,
a.record_deleted_flag,
a.insert_object_run_key,
a.update_object_run_key
from ${target_db=Enter the target database name here}_raw.tdw_tbl_period a
left outer join ${target_db=Enter the target database name here}_raw.tdw_tbl_period_1800_final_updates b
on a.FLNGACCOUNTKEY=b.FLNGACCOUNTKEY
and a.FDTMFILINGPERIOD=b.FDTMFILINGPERIOD;

/**spot checks if necessary**/
select * from ${target_db=Enter the target database name here}_raw.tdw_tbl_period a
where FLNGACCOUNTKEY=1961931136	and  FDTMFILINGPERIOD='2019-03-31 00:00:00'
order by record_effective_timestamp asc --(should not have any ‘1800-01-01 00.00.00 date for record_effective_timestamp)

select count(1) from ${target_db=Enter the target database name here}_raw.tdw_tbl_period a
where record_effective_timestamp='1800-01-01 00:00:00' --12285273
select count(1) from ${target_db=Enter the target database name here}_raw.tdw_tbl_period_final a
where record_effective_timestamp='1800-01-01 00:00:00' --88729875 --(should be more than the count for tdw_tbl_period)

select * from ${target_db=Enter the target database name here}_raw.tdw_tbl_period_final a
where FLNGACCOUNTKEY=1961931136	and  FDTMFILINGPERIOD='2019-03-31 00:00:00'
order by record_effective_timestamp asc --(should have one record for ‘1800-01-01 00.00.00 date for record_effective_timestamp)

--create table ${target_db=Enter the target database name here}_raw.tdw_tbl_period_YYYMMDD stored as parquet
--as select 
--*
--from ${target_db=Enter the target database name here}_raw.tdw_tbl_period a;


/**Now DROP the original tdw_tbl_period table and RENAME the tdw_tbl_period_final TO tdw_tbl_period – this is because we do not have UPDATE option in IMPALA**/
DROP table if exists ${target_db=Enter the target database name here}_raw.tdw_tbl_period;
ALTER TABLE ${target_db=Enter the target database name here}_raw.tdw_tbl_period_final RENAME TO ${target_db=Enter the target database name here}_raw.tdw_tbl_period;

/**End of Final UPDATE 1800 Script **/


/**Make sure you have run the updates scripts for 1800 FIRST !!!!**/
INSERT INTO TABLE  ${target_db=Enter the target database name here}_raw.app_tblperiod
SELECT 
CAST(FLNGACCOUNTKEY AS INT) AS flngAccountKey,
CAST(FDTMFILINGPERIOD AS TIMESTAMP) AS fdtmFilingPeriod,
CAST(FLNGVER AS INT) AS flngVer,
CAST(FLNGVERLAST AS INT) AS flngVerLast,
CAST(FLNGLINKEDACCOUNTKEY AS INT) AS flngLinkedAccountKey,
CAST(FLNGJOINTACCOUNTKEY AS INT) AS flngJointAccountKey,
CAST(FBLNPRIME AS SMALLINT) AS fblnPrime,
CAST(FDTMPERIODBEGIN AS TIMESTAMP) AS fdtmPeriodBegin,
CAST(FDTMPERIODEND AS TIMESTAMP) AS fdtmPeriodEnd,
CAST(FSTRFILING AS VARCHAR(12)) AS fstrFiling,
CAST(FCURTAX AS DECIMAL(19,4)) AS fcurTax,
CAST(FCURTAXBALANCE AS DECIMAL(19,4)) AS fcurTaxBalance,
CAST(FCURTAXDELTA AS DECIMAL(19,4)) AS fcurTaxDelta,
CAST(FCURINTEREST AS DECIMAL(19,4)) AS fcurInterest,
CAST(FCURINTERESTBALANCE AS DECIMAL(19,4)) AS fcurInterestBalance,
CAST(FCURINTERESTDELTA AS DECIMAL(19,4)) AS fcurInterestDelta,
CAST(FCURPENALTY AS DECIMAL(19,4)) AS fcurPenalty,
CAST(FCURPENALTYBALANCE AS DECIMAL(19,4)) AS fcurPenaltyBalance,
CAST(FCURPENALTYDELTA AS DECIMAL(19,4)) AS fcurPenaltyDelta,
CAST(FCUROTHER AS DECIMAL(19,4)) AS fcurOther,
CAST(FCUROTHERBALANCE AS DECIMAL(19,4)) AS fcurOtherBalance,
CAST(FCUROTHERDELTA AS DECIMAL(19,4)) AS fcurOtherDelta,
CAST(FCURCREDIT AS DECIMAL(19,4)) AS fcurCredit,
CAST(FCURCREDITBALANCE AS DECIMAL(19,4)) AS fcurCreditBalance,
CAST(FCURCREDITDELTA AS DECIMAL(19,4)) AS fcurCreditDelta,
CAST(FCURBALANCE AS DECIMAL(19,4)) AS fcurBalance,
CAST(FDTMACTIVITY AS TIMESTAMP) AS fdtmActivity,
CAST(FDTMPENALTY AS TIMESTAMP) AS fdtmPenalty,
CAST(FDTMEFFECTMAX AS TIMESTAMP) AS fdtmEffectMax,
CAST(FDTMDELTA AS TIMESTAMP) AS fdtmDelta,
CAST(FDTMSTATUTE AS TIMESTAMP) AS fdtmStatute,
CAST(FDTMSYSTEMSTATUTE AS TIMESTAMP) AS fdtmSystemStatute,
CAST(FDTMUSERSTATUTE AS TIMESTAMP) AS fdtmUserStatute,
CAST(FBLNSBAEXISTS AS SMALLINT) AS fblnSBAExists,
CAST(FBLNRA AS SMALLINT) AS fblnRA,
CAST(FBLNPNI AS SMALLINT) AS fblnPNI,
CAST(FLNGDOCKEY AS INT) AS flngDocKey,
CAST(FBLNACTIVE AS SMALLINT) AS fblnActive,
CAST(FSTRWHO AS VARCHAR(20)) AS fstrWho,
CAST(EFFECTIVE_FROM AS TIMESTAMP) AS FDTMWHEN,
CAST(record_effective_timestamp AS TIMESTAMP) AS record_effective_timestamp,
CAST(record_expiry_timestamp AS TIMESTAMP) AS record_expiry_timestamp,
CAST(RECORD_ACTIVE_FLAG AS VARCHAR(1)) AS record_active_flag, --Note: this is different from the usual one
CAST('N' AS VARCHAR(1)) AS record_deleted_flag,
CAST(insert_object_run_key AS INT) AS insert_object_run_key,
CAST(update_object_run_key AS INT) AS update_object_run_key
from  ${target_db=Enter the target database name here}_raw.tdw_tbl_period

-- Check row counts of RAW tables with TDW history loaded:

select count(*) as raw_new_count from  ${target_db=Enter the target database name here}_raw.app_tblcollect;
select count(distinct FLNGCOLLECTKEY) as distinct_keys_count FROM  ${target_db=Enter the target database name here}_raw.app_tblcollect;
select count(*) as low_date_count FROM  ${target_db=Enter the target database name here}_raw.app_tblcollect where record_effective_timestamp = '1800-01-01 00:00:00';
select count(*) as high_date_count FROM  ${target_db=Enter the target database name here}_raw.app_tblcollect where record_expiry_timestamp = '9000-12-31 00:00:00';

select count(*) as raw_new_count from  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;
select count(distinct flngDocKey) as distinct_keys_count FROM  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;
select count(*) as low_date_count FROM  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT where record_effective_timestamp = '1800-01-01 00:00:00';
select count(*) as high_date_count FROM  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT where record_expiry_timestamp = '9000-12-31 00:00:00';

select count(*) as raw_new_count from  ${target_db=Enter the target database name here}_raw.app_tblperiod;
select count(distinct flngaccountkey, fdtmFilingPeriod) as distinct_keys_count FROM  ${target_db=Enter the target database name here}_raw.app_tblperiod;
select count(*) as low_date_count FROM  ${target_db=Enter the target database name here}_raw.app_tblperiod where record_effective_timestamp = '1800-01-01 00:00:00';
select count(*) as high_date_count FROM  ${target_db=Enter the target database name here}_raw.app_tblperiod where record_expiry_timestamp = '9000-12-31 00:00:00';
-- Using SAS EG or SAS Studio, run the corresponding RAW START jobs to load data to:
-- app_tbl_nz_rtniit.
-- This will be our first incremental job to load data on top of the data from TDW.
-- Verify jobs complete ok

-- Check the tables after Raw Incrmental load is completed
select count(*) as raw_new_count from  ${target_db=Enter the target database name here}_raw.app_tblcollect;
select count(*) as raw_new_count from  ${target_db=Enter the target database name here}_raw.app_tblNZ_RtnIIT;
select count(*) as raw_new_count from  ${target_db=Enter the target database name here}_raw.app_tblperiod;


-- Run Checks on RAW tables in SAS EG or SAS Studio (Use TDW History Load Check code: History Analysis - STEP 2 and History Analysis - STEP 3). Export Results as PDF.


--Satish to update as required
######################################################################################################################################################################################333

--- Conduct sanity checks for individual keys
select * from  ${target_db=Enter the target database name here}_raw.app_tblperiod
limit 10;

select  flngaccountkey, fdtmFilingPeriod, count(1)
from ${target_db=Enter the target database name here}_raw.app_tblperiod
where record_expiry_timestamp='9000-12-31 00:00:00'
group by flngaccountkey, fdtmFilingPeriod
having count(1)>1

select count(1) from ${target_db=Enter the target database name here}_raw.app_tblperiod
where record_active_flag='Y' --88512347 88510544

select count(*) from ${target_db=Enter the target database name here}_raw.app_tblperiod
where record_active_flag='Y' and record_expiry_timestamp <> '9000-12-31 00:00:00';

select * from ${target_db=Enter the target database name here}_raw.app_tblperiod
where record_active_flag='Y' and record_expiry_timestamp <> '9000-12-31 00:00:00';

select flngaccountkey,fdtmfilingperiod,record_active_flag,record_effective_timestamp,record_expiry_timestamp,insert_object_run_key,update_object_run_key,* 
from ${target_db=Enter the target database name here}_raw.app_tblperiod
where flngaccountkey=38941696 and fdtmfilingperiod='2018-05-31 00:00:00'

select flngaccountkey,fdtmfilingperiod,record_active_flag,record_effective_timestamp,record_expiry_timestamp,insert_object_run_key,update_object_run_key,* 
from ${target_db=Enter the target database name here}_raw.tdw_tbl_period
where flngaccountkey=38941696 and fdtmfilingperiod='2018-05-31 00:00:00'
order by record_effective_timestamp asc

select count(1) from ${target_db=Enter the target database name here}_raw.app_tblperiod
where insert_object_run_key=11613 --1681006

select * from ${target_db=Enter the target database name here}_raw.app_tblperiod
where insert_object_run_key=11613 --1681006

select * from ${target_db=Enter the target database name here}_raw.app_tblperiod
where flngaccountkey=832411712	and fdtmFilingPeriod='2002-03-31 00:00:00'
order by record_effective_timestamp asc


--  ${target_db=Enter the target database name here}_raw.app_tblcustomerstd
select * from  ${target_db=Enter the target database name here}_raw.app_tblcollect
where flngcollectkey=411150
order by record_effective_timestamp asc;